<html>

<head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <style>
        hr {
            margin: 10px 0;
        }
        h4 {
            margin-bottom: 0;
            text-align: center;
        }
        .selected-project {
            display: none;
        }
        .selected-user {
            display: none;
        }

        .show {
            display: block;
        }

        .add-project {
            font-size: 26px;
            padding: 6px 12px 4px 12px;
            margin-right: 0;
        }

        .projects {
            width: calc(100% - 44px);
        }
    </style>
</head>

<body>
    <div id="content">
        <h4>Projects</h4>
        <select class="projects"></select>
        <button class="add-project">+</button>

        <div class="selected-project">
            <label>Project Name:</label>
            <input type="text" class="project-name" />

            <label>Billing Code:</label>
            <input type="text" class="billing-code" />

            <button class="mod-primary project-save" disabled="disabled">Save</button>
        </div>

        <hr />

        <h4>Users</h4>
        <select class="users"></select>

        <div class="selected-user">
            <label>User Group:</label>
            <select class="groups">
                <option value="none"></option>
                <option value="pm">Project Manager</option>
                <option value="designer">Designer</option>
                <option value="artist">Artist</option>
                <option value="programmer">Programmer</option>
                <option value="writer">Writer</option>
            </select>
        </div>
    </div>
</body>

<script>
    var Promise = TrelloPowerUp.Promise;
    var t = TrelloPowerUp.iframe();

    var projectList = [];
    var userList = [];

    t.render(function() {
        t.organization('id').then(function(organization){
            console.log('org',organization)
        });

        return Promise.all([
                t.get('organization', 'shared', 'projects')
            ])
            .spread(function(projects) {
                if(projects) projectList = projects;
                updateProjectList();
            })
            .then(function() {
                t.sizeTo('#content').done();
            })
    });

    /** buttons **/
    jQuery('.done').on('click',function(){
        t.closePopup();
    });
    jQuery('.add-project').on('click',function(){
        jQuery('.projects').prop('disabled', true);
        jQuery('.add-project').prop('disabled', true);
        jQuery('.selected-project').addClass('show').prop('adding', true);
    });
    jQuery('.project-save').on('click',function(){
        var isAdding = jQuery('.selected-project').prop('adding');
        var projectName = jQuery('.project-name').val();
        var billingCode = jQuery('.billing-code').val();
        var editingIdx = jQuery('.selected-project').attr('editing');

        if(isAdding)
            projectList.push({
                'name': projectName,
                'code': billingCode
            });
        else {
            projectList[editingIdx].name = projectName;
            projectList[editingIdx].code = billingCode;
        }

        t.set('organization', 'shared', 'projects', projectList)
            .then(function(){
                jQuery('.projects').prop('disabled', false);
                jQuery('.add-project').prop('disabled', false);
                jQuery('.selected-project')
                    .removeClass('show')
                    .prop('adding', false)
                    .attr('editing', '');
                updateProjectList();
            });
    });

    /** inputs **/
    jQuery('.project-name').on('keyup change',function(){
        setSaveDisabledState();
    });
    jQuery('.billing-code').on('keyup change',function(){
        setSaveDisabledState();
    });
    jQuery('.projects').on('change',function(){
        var idx = jQuery(this).val();
        jQuery('.projects').prop('disabled', true);
        jQuery('.add-project').prop('disabled', true);
        jQuery('.selected-project').addClass('show').attr('editing', idx);
    });

    /** helpers **/
    function checkProjectValid() {
        var projectName = jQuery('.project-name').val();
        var billingCode = jQuery('.billing-code').val();

        var nameExists = false;
        if(projectName) {
            for(var i=0;i<projectList.length;i++) {
                if(projectName.toLowerCase() == projectList[i].name.toLowerCase())
                    nameExists = true;
            }
        }

        var codeExists = false;
        if(projectName) {
            for(var i=0;i<projectList.length;i++) {
                if(billingCode.toLowerCase() == projectList[i].code.toLowerCase())
                    codeExists = true;
            }
        }

        return !nameExists && projectName.length >= 6 && !codeExists && billingCode.length >= 6;
    }
    function setSaveDisabledState() {
        var btn = jQuery('.project-save');
        btn.prop('disabled', !checkProjectValid());
    }
    function updateProjectList() {
        var select = jQuery('.projects');
        select.empty();
        select.appendChild("<option value='-1'></option>");
        for(var i=0;i<projectList.length;i++) {
            var projectName = projectList[i].name;
            var billingCode = projectList[i].code;
            select.appendChild("<option value='"+i+"'>"+projectName+" ("+billingCode+")</option>");
        }
    }
</script>

</html>
